/**
Copyright 2023, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with RTN. It is avalible at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/>
*/

import{Line as e,Fork as t,Bend as r,Gap as s,Data as a,New as n,End as i,Null as l}from"./treeblocks.js";import{URIMannager as o}from"./URI-mannager.js";export default class h{constructor(e,t,r){this.maxURLLength=8192,this.uri=new o,window.main=this;var s=this.pullURL();this.raw=new RawBuffer(e),this.exe=new ExeBuffer(t),this.wrap=r,this.state="UNLOCKED",this.raw.ref.addEventListener("keydown",e=>this.keyPreRouter(e)),this.raw.ref.addEventListener("input",()=>this.keyPostRouter()),this.raw.ref.addEventListener("copy",e=>this.handleCopy(e)),this.raw.ref.addEventListener("click",e=>this.urlPreEncodeOnIdle(e)),this.raw.ref.addEventListener("input",()=>this.urlPreEncodeOnIdle()),this.raw.ref.addEventListener("paste",e=>this.handlePaste(e)),this.raw.ref.addEventListener("keydown",e=>this.syncScrollbars(e)),this.raw.ref.addEventListener("click",e=>this.syncScrollbars(e)),document.addEventListener("wheel",e=>this.scaleTextOnZoom(e),{passive:!1}),this.intervalUpdater=setInterval(()=>this.intervalUpdate(),1e3),this.focused=!0,document.addEventListener("visibilitychange",e=>this.focusToggle(e)),window.addEventListener("beforeunload",e=>this.safeShutdown(e)),this.setURL(s),this.keyPostRouter(),this.syncScrollbars(),this.handlePaste(),""!=s&&null!=s&&(document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32))}debugDump(){console.debug("=====STARTING=DEBUG=DUMP====="),console.debug("Source Value:"),console.debug(this.raw.ref.value.replaceAll("\n","\\n").replaceAll("	","\\t")),console.debug("-----------------"),console.debug("Display Value:"),console.debug(this.exe.ref.innerHTML.replaceAll("\n","\\n").replaceAll("	","\\t")),console.debug("=====END=DEBUG=DUMP=====")}safeShutdown(e){clearInterval(this.intervalUpdater),console.debug("RTN Safe Shutdown Complete.")}focusToggle(e){this.focused=!this.focused,"hidden"===document.visibilityState?this.focused=!1:"visible"===document.visibilityState&&(this.focused=!0)}scaleTextOnZoom(e){if(!e.ctrlKey)return;e.preventDefault();let t=parseFloat(document.getElementById("display").style.fontSize),r=parseFloat(document.getElementById("display").style.top),s=parseFloat(document.getElementById("source").style.fontSize);e.deltaY>0&&(t=Math.max(.5,t-.1),s=Math.max(.5,s-.1)),e.deltaY<0&&(t=Math.min(2,t+.1),s=Math.min(2,s+.1)),r=-1*t,document.getElementById("display").style.fontSize=t+"vw",document.getElementById("source").style.fontSize=s+"vw",document.getElementById("display").style.top=r+"vw"}intervalUpdate(){this.focused&&this.keyPostRouter()}darkenBorder(){var e=document.getElementById("display").style.border;if(""!=e){var t=parseInt(e.substring(17,20));if(0==t){clearInterval(this.outlineInterval);return}t=Math.max(t-5,0),document.getElementById("display").style.border=`0.25vw solid rgb(${t},${t},${t})`}}redir(e,t){e.preventDefault(),t=t.replaceAll("#","");var r="";switch(t){case"help-indentation":r="./program.html?enc=URI-B64&cmpr=LZMA2&data=3YCAgILphoCAgICAgIDkOxgOtOa1RMWtC1rAWgHD4MuS2q4s-N7_eczgABt9OWpoi5V3uc9KWgITdID0KJ7OLRRh3HlkPu04VZFxrO3tKXJ7f3IKWBHU0q03LrS5PuobDSkddQkpvWcCmWagcPrhDnGzx3OoPOt4EhEIQjOxtqU3GJo470FmiRu6-OUiz75FJ6sBBdbgfBEHPW5R3W-6Jispd3WiJ1u9eJIxJUxVp4JZNPgz8aMjmxFkZREwJlLaOGHWjZqIW0qWoJgG-_Y5_44xQxkPJ4yfzHXVWWiI_EDURZWieuUU3858-VwiZ7afzJ4RWc3uIDdhTIlUGumcoZXa27uTZDRFGEXvoknP8n3lVaVEj1ciNydGtsiuZWA9ILEuP38ACe2gz9hyyFGzFtfMr40yTH6HuAX3kAI2eGQpGoBr7Lq-1UqRF55PjQeHOhHWzR4URk7dZiz_4ukMLoacSIdh5T4_toR8bBnt-xPrkvGrH9tR-uZ_337l-wRuFNjKEimxyqOLm57p7_Aq7y64QM_pSXiHYy6mDDUItaaqFe4G5HGaLTOaKMN2eWklpSqc4D_E-V5qPswmVsnraXtPjWowwluyeVRumKgq3poBKHS5iub1WHDIuGzs8I1uyeu0AUXpR4NmT4jxNVftddfNSe4JwfvL-LggOyh7Jw5VqWUBrn2xp_kLr9EHf0mcsgA";break;case"help-text_formatting":r="./program.html?enc=URI-B64&cmpr=LZMA2&data=3YCAgILai4CAgICAgIDquduPqXb7jRIeXZJa5quXL-_YBULetrv7Fa9zmEMC2eluivt2vlCNZPiuXsbhkv_GjRA-b-HKc2DxUmBI4U5mH-sgkkrVSDLm2sbiGLCKZ1npMhvi7MoVVP9nZ5FGbmAw65D3aTQiA1gxofLLmGoVYs5WohUUrc8JknZQ6GsEYIST0CYspt_flZYi_sLWMVZCN0SZSwAfjIbWorOqB-QW05HfuubNlhmH82QDGLWKiWkgV3rToBJsg5HYo3-r0_v8e1QDlDz3imUAck5mzoG0RhBrXHqE92loavL0hX0XxSd6Bs1Nty5oOEf-TXE0Uu1nL-Dvn2BJ1_opeElPQZ4jASNYSxQkpCjByHpzjEyp8RBOlOsfNLKmaf10oIV-1qnN2YFMPuoQjLKVQVY9vW4SqqotAMvIP8bPfGSCe6X8tufidslIzTQYo-cg4bebw2Yrp7eldOaNpdVjproufTjApo-m2wyFH3elDkHfirbkHB-0ZtKUa-m4esdIn-xwN-ik-O9Ix8qvT1W91ysiIDS6FIiieb4SC8KL1PUsl27c6wLR1Q2dbL6tSsV36zFfdzPnyzQOkbtOBhlg2lZx7WEW9EM-Rf7fa_morYQKT3t5lU7sleg_NK_56lcz3UHhjMl-LDD5Zq3z3fXgAW53Wc0NTbWXYgd0pNlEAX0Ztp7UD6mN3a829d9XOq1wgvBDP1PLlZ12-2fowjie5TNsZwSoZt1kGsLwPJYFWsnTra8zY8xLh2pGz2lsQU1Wr2JEcWoZEC3jNZqYujJpnpRTLJp6Jcxsyzb65BiqMPWtpWj99I4Q9FYICq2_TUAUaJ59bpFY8ubOlfI-AQNG2Yx7y-W49_v1WufVkDLmQYEora48kwFqNkHh8PajsKkYUjEcZZbHBdiRBjUomLl1UvfF568f17vVRIuORTYNEZ3ArtZ5enbDxT25vihTLwn6B8f84-hNpKFPbwR_lU9LbyvYDWBQienQeE_ElXqJkgEDGajAPuozNb80M6fhDdGNJ9ug_WyZlj_WRRAugMxPn6W0xwrtaNvk7Vf6HUG-ZVPbC7osp-tWPjsUQUPdRXt2W7fZHTatXOoTe-yF0mZu-vl4UWvCtodD4J5J96b7QBu_3ncNI6mCm6m22s5qdKbKRzt4RwQdYskeeIF-Ba9mAZPaOQN9ODA8NvPBQkYk_lpKPeAZd-hNB-KwgCnq3zav8_TmpNnvDfZI0vFbW3FNWmDiIBUQxEGWNo6Lfgiyew";break;case"help-color_control":r="./program.html?enc=URI-B64&cmpr=LZMA2&data=3YCAgIK2hYCAgICAgIDhO1kOZubIfbdOaZ6jTxWIq-i-xz9-HbveW2rGJk_L2-k52k7-ExQuFW_4hTZr1aIQzNO5FhLr-Sgdup_csPMZt5azFtX7yGg2bNT7gpFTfSjHpQnCKVPljEfFYQGtWQfQCzESnAg_tl8Kua0EXl4YkF02fNb_VBqA-_Z4v1Cbrlwpu8C2KXAjg-2qfcyV76zBZu8DQCE14jNsE0NOTgH1MFaR8mrdLXq1mDfwr06aDg-AsV6_YoYiuGi12oJVCk7t-TXV6EFkGlv165TIAW1NZhjDPHQXNOpabwTOhV_QLG6bkNT8-xJiouHjzdZh0N5Ze6H-YgvVFvCd0Seah2b_4_E_HkzhCiTqorg2g-YicZNS81mGxF1HZDLjonuFSqoz8ESG-Ep5A4LexltIKk5NT2TvWGqtcLNWDzG5I_TX-YKAI_C2QMyghMKj7_cld1OUep_VyblwvuHUKvV_rIlTBhxIBnd1ekfe0CKudRustcuk2Q5mnCLuR3DU9cvJdnhZ5F2tqoJHf3aZ22IjBgDKtMi-Es73fJnz_y9PgONMYDjrvDBvBo2bxE5XaN0UmV2jHfhtA2v7CyCL4COxCZ0WhzjCbI3Eqh7UhS8c7-Q6trlfwqyLulyqc142f0jkQA0";break;case"help-dnl":r="./program.html?enc=URI-B64&cmpr=LZMA2&data=3YCAgIKehoCAgICAgIDiutrOq5LNtAw18HOWiMAW1rroU-DyU6OTOoWHEPG-qGBiF0AQurJBssKAtrelsj1rjqxX14u6oUB8FnC3uv_GWNOHszDfLh4a-Qe2R4h7EdFTJCYLGorvsjVgsM9K4vERHDqoRda7OK0q7jrxfTqLNT_VoxeOjP4e6D2tQHertb6N3CPFO_aWqSRdcYjQDxSWjUxE6f7UmBEMJ6OxtScvkHKoYZVGOsnv0SbzB1HXweVcBqRxgKpceyWIF7fy4gAvyC3OUNQWnQDh5YhJS-40UKa7lyk998N0FUqlhy1FwtOT61JyMzVggkWVM7AhgQbnMcCE-87kMjR5yFOUbODXHAOuvgmBufU-fF8j9-5ADPsIqaHTBrqQ1nLa1j7NUx9csfC8cafHig915884xXgOFLjBb_OVeuidnbv8E2wzRpOrANQICPQYr5WAQ9UmTiG0vRpZiCzxNX3CiSaMfECmpkbuG5p4IN6atIzan3DnnxaYuftCyHR4jI9xKA6lX0LJV8QbP5ZqGYG1RUxwFqhiarmQCP7VrlEBWTW8mpoPYBEwH0wG-iDiKYdkIZLI9zRG9P8rYwGpuNDFK_05BmWaSZRcBFZr3rWurGt59-erRwoCIZVsRvigmCwwCmaAyRtcapk0GiwrtsGEQP3IsvPCNYwZJCDvTMY04PdzYPepGORcwjtt4p7zY0_n6JaPBYXBHLX3qI8hOP2sTFdlByN5ZgVPvJRFk-Oo1hw0EcwT4UJk4xf6BIc6_flgF_JHLkaVi0qSknCDMm9NhHS3A4sl7XBqnPnq7inpE0U4NZ9Ho4XxTAo9w0HWjG0JOAifpyBl-hEsYiHF8KAKo0B5no7qTEgoDQDTcKsNgxTl3XR_YaN3uA";break;default:console.error(`Invalid redir called.
TARGET: ${t}`);return}var s=document.createElement("a");s.href=r,s.target="_blank",s.rel="noopener noreferrer",s.click(),s.parentNode.removeChild(s)}urlPreEncodeOnIdle(){let e=8192*Math.random()+0;this.shouldEncode=e,setTimeout(()=>this.urlPostEncodeOnIdle(e),1e3)}urlPostEncodeOnIdle(e){this.shouldEncode==e&&(this.pushURL(),document.getElementById("display").style.border="0.25vw solid rgb(255,255,255)",this.outlineInterval=setInterval(()=>this.darkenBorder(),10),document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32))}pullURL(){return this.uri.pull()}setURL(e){""!=e?this.raw.ref.value=e:this.raw.ref.value="Rapid Tree Notetaker\n	What is this?\n		The Rapid Tree Notetaker (RTN) is a notetaking tool developed by computer science student Brendan Rood at the University of Minnesota Duluth.\n		It aims to provide an easy way to take notes formatted similar to a Reddit thread, with indentation following a tree-like structure allowing for grouping.\n		It also prioritizes ease of sharing, as the URL can be shared to instantly communicate the note's contents.\n			Notice how the border is flashing?\n			Every time you see that, it means that the document has been saved to the URL!\n			If the URL ever becomes longer than 8192 characters, it will alert you that saving is no longer possible.\n		It is free to use and will never ask you to log in.\n	Sample\n		Edit this text\n		to generate\n			a\n			document\n		formatted\n			like a tree!\n			:3\n	Misc. Instructions - *Click yellow links to view!*\n		[Indentation](#help-indentation)\n			Use TAB to indent\n		[Text Formatting](#help-text_formatting)\n		[Color and Highlighting](#help-color_control)\n		[DNL Links / Intradocument References](#help-dnl)"}pushURL(){var e=this.exe.ref.textContent.replace(/[\s]+$/,"");this.exe.tree.input=e,this.exe.tree.totalParse(),e=(e=(e=(e=(e=(e=(e=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/<[^>]*>/g,"")).replace(/(\s*)(•)(.*)/gm,"$1-$3"),console.debug(e),this.uri.push(e)}keyPreRouter(e){this.raw.keyHandler(e,e=>this.keyPostRouter(e)),this.urlPreEncodeOnIdle()}keyPostRouter(){this.raw.update(),this.exe.ref.innerHTML=this.raw.ref.value.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),this.exe.update(),this.syncScrollbars()}handlePaste(e){setTimeout(()=>{this.raw.ref.value=this.raw.ref.value.replace(/├────── |│       |└────── |        /gm,"	"),this.raw.ref.value=this.raw.ref.value.replace(/├── |│   |└── |    /gm,"	")},100),setTimeout(e=>this.syncScrollbars(e),100)}handleCopy(e){e.preventDefault(),this.keyPostRouter();var t=this.raw.ref.selectionStart,r=this.raw.ref.value.substring(0,t),s=u(r),a=this.raw.ref.selectionEnd,n=this.raw.ref.value.substring(t,a),i=u(n),l=this.raw.ref.selectionStart+8*s,o=this.raw.ref.selectionEnd+8*s+8*i,h=this.exe.ref.textContent.substring(l,o);function u(e){var t=e.match(/\t/gm);return null!=t?t.length:0}this.exe.tree.input=h,this.exe.tree.totalParse(),h=(h=(h=(h=(h=(h=(h=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/(\s*)(•)(.*)/gm,"$1-$3")).replace(/\s$/,""),navigator.clipboard.writeText(h)}syncScrollbars(e){let t=document.getElementById("display"),r=document.getElementById("source"),s=document.getElementById("main"),a=document.getElementById("header");s.style.top=`${a.offsetHeight+10}px`;let n=`${t.offsetHeight+50}px`,i=`${t.offsetWidth+s.offsetLeft}px`;s.style.height=n,s.style.width=i,r.style.height=`${t.offsetHeight}px`,r.style.width=`${t.offsetWidth+s.offsetLeft}px`,s.style.minWidth=`${a.offsetWidth}px`,r.style.minWidth=`${a.offsetWidth}px`,t.style.minWidth=`${a.offsetWidth}px`}hardFix(){this.raw.update(),this.exe.ref.tree.input=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update();var e=this.raw.ref.selectionStart,t=this.raw.ref.selectionEnd;this.raw.ref.value=this.exe.tree.content.substring(0,this.exe.tree.content.length-1),this.raw.update(),this.exe.ref.textContent=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update(),this.raw.ref.selectionStart=e,this.raw.ref.selectionEnd=t}scrollToCaret(e){var t=document.createElement("div");t.style.position="absolute",t.style.color="red",t.style.padding="5px",t.style.wordBreak="normal",t.style.whiteSpace="pre-wrap",t.style.border="solid 0.25vw transparent",t.style.fontSize=document.getElementById("source").style.fontSize,document.getElementById("main").appendChild(t),t.innerHTML=e.value.substring(0,e.selectionEnd)+'<span id="scrollCarrat"></span>',document.getElementById("scrollCarrat").scrollIntoView({behavior:"smooth",block:"center",inline:"end"}),document.getElementById("scrollCarrat").remove(),document.getElementById("main").removeChild(t)}dirnav(e,t,r,s=!1){if(s||e.preventDefault(),!0==document.getElementById("source").hidden){e.preventDefault();return}for(var a=this.raw.ref.value.split("\n"),n=a.length-1,i=r,l=t.split("/").filter(e=>null!=e&&""!==e&&"DNL."!==e&&"RTN."!=e&&"DL."!=e);0!=l.length;)switch(l[0]){case"RTN.":case"DNL.":case"DL.":l.shift();break;case"RTN":case"DNL":case"DL":var o=0;if(o<0)return console.debug("DirNav called for invalid Indent Level "+o,debug),!1;for(;i>=0&&y(a[i])!=o;)i--;if(i<0)return console.debug("DirNav could not find a proper parent...",debug),!1;l.shift();break;case"RTN~":case"DNL~":case"DL~":var o=1;if(o<0)return console.debug("DirNav called for invalid Indent Level "+o,debug),!1;for(;i>=0&&y(a[i])!=o;)i--;if(i<0)return console.debug("DirNav could not find a proper parent...",debug),!1;l.shift();break;case"..":var o=y(a[i])-1;if(o<0)return console.debug("DirNav called for invalid Indent Level "+o,debug),!1;for(;i>=0&&y(a[i])!=o;)i--;if(i<0)return console.debug("DirNav could not find a proper parent...",debug),!1;l.shift();break;default:var h=y(a[i]);if(l[0].match(/\[[0-9]*\]/)){for(var u=parseInt(l[0].substring(1,l[0].length-1),10),c=-1;c<u&&i<=n;){if(y(a[++i])<=h)return console.debug("DirNav failed to find a child of index ["+u+"] before exhausting the domain!",debug),!1;y(a[i])==h+1&&c++}l.shift()}else{let p=l[0].substring(1,l[0].length-1).replace(/^([^a-zA-Z0-9]*)(.*)/,"$2"),d=RegExp("^\\s*[^a-zA-Z0-9]*"+p+".*");for(;!a[i].match(d)&&i<=n;)if(y(a[++i])<=h){if(p.startsWith("Invalid links will do nothing when clicked"))return!1;return console.debug("DirNav failed to find a child of key ["+p+"] before exhausting the domain!",debug),!1}l.shift()}}if(s)return!0;for(var f="",g=0;g<i;g++)f+=a[g]+"\n";var b=(f=f.substring(0,f.length-1)).length,v=a[i].match(/^(\s*)([^\n]*)/),$=v[1].length,_=v[2].length;return this.raw.start=b+$,this.raw.end=b+$+_,0!=this.raw.start&&(this.raw.start++,this.raw.end++),this.raw.ref.focus(),this.raw.writeCarrat(),this.scrollToCaret(this.raw.ref),!0;function y(e){return null==e||""==e?0:e.split("	").length-1}}};class LevelNode{constructor(e,t){this.level=e,this.value=t}}class ProcessingTree{constructor(e){this.input=e,this.nodes=[],this.blocks=[],this.output=""}toNodes(){var e=this.input.split("\n");for(var t of e){var r=a(t);t=s(t),this.nodes.push(new LevelNode(r,t))}function s(e){var t=e;return t.replaceAll(/\t/g,"")}function a(e){var t=e.match(/^\t*(\t)/gm);return null!=t?t[0].length:0}}toBlocks(){for(var e of this.nodes){for(var t=[],r=0;r<e.level;r++)t.push(new n);""==e.value?t.push(new i):t.push(new a(e.value)),this.blocks.push(t)}}parseNewBlocks(){for(var a=this.blocks,n=0;n<a.length;n++)for(var i=0;i<a[n].length;i++){var l="";if(""==l&&"Data"==d(n,i,a)&&(l="Data"),""==l){var o=null;if("Data"==d(n,i+1,a)&&(("Null"==d(n+1,i,a)||"Data"==d(n+1,i,a))&&(o=!0),null==o)){var h=c(n,i,a),u=p(n,i,a);function c(e,t,r){for(var s=0;e<r.length&&!(e+1>r.length-1);){var a=d(e+1,t,r);if("Data"==a||"Null"==a)break;s++,e++}return s}function p(e,t,r){for(var s=0;e<r.length&&!(e+1>r.length-1);){var a=d(e+1,t+1,r);if("Data"==a||"Null"==a)break;s++,e++}return s}o=h<=u}o&&(a[n][i]=new r,l="Fork")}""==l&&"Data"==d(n,i+1,a)&&(a[n][i]=new t,l="Fork"),""==l&&("Gap"==d(n-1,i,a)||"Bend"==d(n-1,i,a))&&(a[n][i]=new s,l="Gap"),""==l&&("Line"==d(n-1,i,a)||"Fork"==d(n-1,i,a))&&(a[n][i]=new e,l="Line")}function d(e,t,r){return e<0||t<0||r.length-1<e||r[e].length-1<t?"Null":r[e][t].type}this.blocks=a}toString(){for(var e="",t=this.blocks,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)e+=t[r][s].data;e+="\n"}this.output=e}totalParse(){this.nodes=[],this.blocks=[],this.output="",this.toNodes(),this.toBlocks(),this.parseNewBlocks(),this.toString()}}class VirtualBuffer{constructor(e){this.ref=e,this.start=e.selectionStart,this.end=e.selectionEnd,this.state="UNLOCKED"}writeCarrat(){this.ref.selectionStart=this.start,this.ref.selectionEnd=this.end}readCarrat(){this.start=this.ref.selectionStart,this.end=this.ref.selectionEnd}moveCarrat(e){this.start+=e,this.end+=e,this.writeCarrat()}countCaretLeft(){var e=this.ref.value.substring(0,this.start).split("\n");return e[e.length-1].split("	").length-1}keyHandler(e,t){if(console.log(e),void 0==e&&(e={key:"none"}),"LOCKED"==this.state){setTimeout(()=>{this.keyHandler(e,t)},10);return}if(this.readCarrat(),"Tab"==e.key){if(e.preventDefault(),this.start==this.end)u(this.ref.value,this.start)&&(this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1));else{for(var r=this.start,s=this.end-1;"\n"!=this.ref.value.substring(r,r+1)&&r>0;)r--;for(;"\n"!=this.ref.value.substring(s,s+1)&&s>0;)s--;var a=[],n=r;for(a.push(r);n<s-1;)n++,"\n"==this.ref.value.substring(n,n+1)&&a.push(n);if(s!=r&&a.push(s),e.shiftKey){var i=0;for(var l of a)"	"==this.ref.value.substring(l+i+1,l+i+2)&&(this.ref.value=this.ref.value.substring(0,l+i+1)+""+this.ref.value.substring(l+i+2),i--,this.ref.selectionStart=l+i,this.ref.selectionEnd=l+i)}else{var i=0;for(var l of a)u(this.ref.value,l+i+1)&&(this.ref.value=this.ref.value.substring(0,l+i+1)+"	"+this.ref.value.substring(l+i+1),i++,this.ref.selectionStart=l+i,this.ref.selectionEnd=l+i)}}}if("Enter"==e.key&&(e.preventDefault(),function e(t,r){var s=t.substring(0,r).split("\n"),a=l(s[s.length-1])>0,n=t.split("\n")[s.length];null==n&&(n="PROCEED");var i=l(n)>0;return!0==a&&!0==i;function l(e){var t=e.match(/\S/gm);return null!=t?t.length:0}}(this.ref.value,this.start)&&this.start==this.end)){var o=this.countCaretLeft();this.ref.value=this.ref.value.substring(0,this.start)+"\n"+this.ref.value.substring(this.end),this.moveCarrat(1);for(var h=0;h<o;h++)this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1);window.main.scrollToCaret(this.ref)}function u(e,t){var r=e.substring(0,t).split("\n").length,s=e.split("\n"),a=s[r-1],n="";s.length>1&&(n=s[r-2]);var i,l,o=u(a),h=u(n);if(a=(a=e.substring(0,t).split("\n"))[a.length-1],o<h+1&&(i=a,l=i.match(/([\S ]+)/g),!((l=null!=l?l[0].length:0)>0)))return!0;return!1;function u(e){if(""==e)return 0;var t=e.match(/^(\t*)/g);return null!=t?t[0].length:0}}this.state="LOCKED",setTimeout(()=>{t()},10)}update(){this.state="UNLOCKED",this.readCarrat()}}class RawBuffer extends VirtualBuffer{constructor(e){super(e)}update(){this.ref.value=this.ref.value.replace(/[└├│─ ]*​/gm,"	"),this.ref.value=this.ref.value.replace(/(?:\t+[\S ]+)(\t+)/gm,"	"),super.update()}}class ExeBuffer extends VirtualBuffer{constructor(e){super(e),this.tree=new ProcessingTree("")}update(){this.tree.input=this.ref.textContent,this.tree.totalParse();for(var e=this.tree.output,t=(e=(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")).replace(/(\[(.+?)\]\((.+?)\))|(https?:\/\/\S+)/g,function(e,t,r,s,a){return s?s.startsWith("#")?`<a style="z-index: 4; pointer-events: all; position: relative; color: yellow;" href="#" onclick="window.main.redir(event, '${s}')" target="_blank" rel="noopener noreferrer"><b>[${r}](${s})</b></a>`:`<a style="z-index: 4; pointer-events: all; position: relative;" href="${s}" target="_blank" rel="noopener noreferrer"><b>[${r}](${s})</b></a>`:`<a style="z-index: 4; pointer-events: all; position: relative;" href="${a}" target="_blank" rel="noopener noreferrer"><b>${a}</b></a>`})).split("\n"),r=0;r<t.length;r++)window.dirnavIndex=r,t[r]=t[r].replace(/(DNL|RTN|DL)([\.\~]{0,1})((?:\/\.\.|\/\[[^\]]+\])+)(\/?)/g,function(e,t,r,s,a){var n=window.main.dirnav(null,t+r+s+a,window.dirnavIndex,!0)?"#52eb00":"#ff5555";let i=`<a style="z-index: 4; pointer-events: all; position: relative; color: ${n};" href="#" onclick="window.main.dirnav(event, '${t+r+s+a}', ${window.dirnavIndex});"><b>${t+r+s+a}</b></a>`;return i});var s="";for(var a of t)s+=a+"\n";e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=s=s.substring(0,s.length-1)).replace(/((?:\&lt\;)?)(-+|=+)((?:\&gt\;)?)/g,function(e,t,r,s){var a=t+r+s;return a.startsWith("&lt;")||a.split("").reverse().join("").startsWith(";tg&")?`<b>${a}</b>`:a})).replace(/(?<!\*|\\)(\*{1})([^\n*]+?)(\1)(?!\*|\\)/g,'<span style="color:cyan"><b>$1</b></span><i>$2</i><span style="color:cyan"><b>$3</b></span>')).replace(/^((?:[└├│─ ]*​)*)(-)( )/gm,'$1<span style="color: rgb(255,215,0)">•</span>$3')).replace(/^((?:[└├│─ ]*​)*)(\*)( )(?!.*\*)/gm,'$1<span style="color: rgb(255,215,0)">•</span>$3')).replace(/^((?:[└├│─ ]*​)*)([0-9]+\.)( )/gm,'$1<span style="color: rgb(255,215,0)"><b>$2</b></span>$3')).replace(/(?<!\_|\\)(\_{2})([^\n_]+?)(\1)(?!\_|\\)/g,'<span style="color:cyan"><b>$1</b></span><u>$2</u><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\||\\)(\|{2})([^\n\|]+?)(\1)(?!\||\\)/g,'<span style="color:cyan"><b>$1</b></span><a style="z-index: 4; pointer-events: all; position: relative;" href="#s" title="$2"><span style="font-size: 0vw;">$2</span></a><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\*|\\)(\*{2})([^\n*]+?)(\1)(?!\*|\\)/g,'<span style="color:cyan"><b>$1</b></span><b>$2</b><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\*|\\)(\*{3})([^\n*]+?)(\1)(?!\*|\\)/g,'<span style="color:cyan"><b>$1</b></span><i><b>$2</b></i><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\~|\\)(\~{2})([^\n~]+?)(\1)(?!\~|\\)/g,'<span style="color:cyan"><b>$1</b></span><del>$2</del><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\\|\!)(\^)(.*?)(\^)(?<!\\|\!)/g,'<b>$1</b><span style="display: inline-block; top: -0.2vw; position: relative; line-height: 0.000001em; margin-block: 0;">$2</span><b>$3</b>')).replace(/(?<!\\)(\!\^)(.*?)(\!\^)(?<!\\)/g,'<b>$1</b><span style="display: inline-block; top: 0.2vw; position: relative; line-height: 0.000001em; margin-block: 0;">$2</span><b>$3</b>')).replace(/(?<!\`)(\`{1})([^\n`]+?)(\1)(?!\`)/g,'<span style="color: rgb(232,145,45); background-color: rgb(44, 46, 54);"><b>$1</b>$2<b>$3</b></span>')).replace(/(RE)(\/)((?:[^\r\n\t\f\v ]|\\ )+)(\/)([gmixsuUAJD]*)/g,'<span style="background-color: rgb(44, 46, 54)"><span style="color: rgb(23,159,241)"><b>$1$2</b></span><span style="color: rgb(192,90,81)">$3</span><span style="color: rgb(23,159,241)"><b>$4$5</b></span></span>')).replace(/(\[hc)([0-9abcdef])([0-9abcdef])([0-9abcdef])(\])(.*?)(\1)(\2)(\3)(\4)(\5)/g,function(e,t,r,s,a,n,i,l,o,h,u,c){let p=parseInt(`${r}0`,16),d=parseInt(`${s}0`,16),f=parseInt(`${a}0`,16);return Math.max(p,d,f)>127?`<b>${t}${r}${s}${a}${n}</b><span style="color: #101010; background-color: #${r}0${s}0${a}0;"><b>${i}</b></span><b>${l}${o}${h}${u}${c}</b>`:`<b>${t}${r}${s}${a}${n}</b><span style="background-color: #${r}0${s}0${a}0;"><b>${i}</b></span><b>${l}${o}${h}${u}${c}</b>`})).replace(/(\[tc)([0-9abcdef])([0-9abcdef])([0-9abcdef])(\])(.*?)(\1)(\2)(\3)(\4)(\5)/g,function(e,t,r,s,a,n,i,l,o,h,u,c){return`<b>${t}${r}${s}${a}${n}</b><span style="color: #${r}0${s}0${a}0; text-shadow: -1px -1px 5px black, -1px 0px 5px black, -1px 1px 5px black, 0px -1px 5px black, 0px 1px 5px black, 1px -1px 5px black, 1px 0px 5px black, 1px 1px 5px black;"><b>${i}</b></span><b>${l}${o}${h}${u}${c}</b>`})).replace(/[└├│─ ]*​/gm,function(e){return`<span style="color: cyan;">${e}</span>`}),this.ref.innerHTML=e,super.update()}}